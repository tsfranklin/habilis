<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - H√ÅBILIS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <!-- Navbar Profesional -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-shapes"></i> H√ÅBILIS
            </a>
            <div class="nav-links">
                <a href="user-dashboard.html" class="nav-link">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="quiz.html" class="nav-link">
                    <i class="fas fa-boxes"></i> Cat√°logo
                </a>
                <a href="cart.html" class="nav-link active">
                    <i class="fas fa-shopping-cart"></i> Carrito
                </a>
                <button onclick="logout()" class="btn btn-logout">Salir</button>
            </div>
        </div>
    </nav>

    <!-- Carrito -->
    <div class="container" style="max-width: 1000px;">
        <div style="text-align: center; margin-bottom: 2.5rem;">
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                <i class="fas fa-shopping-cart" style="color: var(--secondary);"></i> Mi Carrito
            </h1>
            <p style="color: var(--text-light);">Revisa tus productos antes de finalizar</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 380px; gap: 2rem; align-items: start;">
            <!-- Cart Items -->
            <div>
                <div id="cartItems"></div>
            </div>

            <!-- Cart Summary (Sticky) -->
            <div class="cart-summary">
                <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--primary);">Resumen del Pedido</h3>

                <div class="summary-row">
                    <span style="color: var(--text-light);">Subtotal:</span>
                    <span id="cartSubtotal" style="font-weight: 600;">‚Ç¨0.00</span>
                </div>

                <div class="summary-row">
                    <span style="color: var(--text-light);">Env√≠o:</span>
                    <span style="font-weight: 600; color: var(--accent);">GRATIS</span>
                </div>

                <div class="summary-row summary-total">
                    <span style="font-size: 1.25rem;">Total:</span>
                    <span id="cartTotal" style="font-size: 1.75rem;">‚Ç¨0.00</span>
                </div>

                <button onclick="checkout()" class="btn btn-primary" id="checkoutBtn"
                    style="width: 100%; margin-top: 1.5rem; padding: 1.125rem;">
                    <i class="fas fa-check-circle"></i> Realizar Pedido
                </button>

                <p style="text-align: center; font-size: 0.875rem; color: var(--text-light); margin-top: 1rem;">
                    <i class="fas fa-lock"></i> Pago seguro garantizado
                </p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        let products = {};

        async function loadCart() {
            const container = document.getElementById('cartItems');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-shopping-cart" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1.5rem;"></i>
                        <h3 style="color: var(--text-dark); margin-bottom: 1rem;">Tu carrito est√° vac√≠o</h3>
                        <p style="color: var(--text-light); margin-bottom: 2rem;">¬°Descubre nuestros kits educativos!</p>
                        <a href="quiz.html" class="btn btn-primary">
                            <i class="fas fa-boxes"></i> Explorar Cat√°logo
                        </a>
                    </div>
                `;
                document.getElementById('checkoutBtn').disabled = true;
                return;
            }

            // Load product details
            for (const item of cart) {
                if (!products[item.productoId]) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/productos/${item.productoId}`);
                        products[item.productoId] = await response.json();
                    } catch (error) {
                        console.error(`Error loading product ${item.productoId}:`, error);
                    }
                }
            }

            // Display cart items
            container.innerHTML = cart.map((item, index) => {
                const product = products[item.productoId];
                if (!product) return '';

                const subtotal = product.precio * item.cantidad;
                return `
                    <div class="card" style="padding: 1.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--primary);">${product.nombre}</h3>
                            <p style="color: var(--text-light); font-size: 0.9375rem; margin-bottom: 0.75rem;">${product.descripcion || ''}</p>
                            <p style="color: var(--secondary); font-weight: 700; font-size: 1.125rem;">‚Ç¨${product.precio.toFixed(2)} /unidad</p>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 2rem;">
                            <!-- Quantity Controls -->
                            <div style="display: flex; align-items: center; gap: 0.75rem; background: var(--bg-light); padding: 0.5rem 1rem; border-radius: 50px;">
                                <button onclick="updateQuantity(${index}, -1)" class="btn btn-sm" style="width: 32px; height: 32px; padding: 0; border-radius: 50%;">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span style="font-weight: 700; font-size: 1.125rem; min-width: 30px; text-align: center;">${item.cantidad}</span>
                                <button onclick="updateQuantity(${index}, 1)" class="btn btn-sm" style="width: 32px; height: 32px; padding: 0; border-radius: 50%;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>

                            <!-- Subtotal -->
                            <div style="text-align: right; min-width: 100px;">
                                <p style="font-size: 1.5rem; font-weight: 700; color: var(--secondary); margin-bottom: 0.25rem;">‚Ç¨${subtotal.toFixed(2)}</p>
                                <button onclick="removeItem(${index})" class="btn btn-sm btn-danger" style="font-size: 0.875rem;">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateTotals();
        }

        function updateQuantity(index, change) {
            cart[index].cantidad += change;
            if (cart[index].cantidad <= 0) {
                removeItem(index);
            } else {
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
            }
        }

        function removeItem(index) {
            if (confirm('¬øSeguro que quieres eliminar este producto del carrito?')) {
                cart.splice(index, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
            }
        }

        function updateTotals() {
            let total = 0;
            cart.forEach(item => {
                const product = products[item.productoId];
                if (product) {
                    total += product.precio * item.cantidad;
                }
            });

            document.getElementById('cartSubtotal').textContent = `‚Ç¨${total.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `‚Ç¨${total.toFixed(2)}`;
        }

        async function checkout() {
            if (cart.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }

            const checkoutBtn = document.getElementById('checkoutBtn');
            checkoutBtn.disabled = true;
            checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

            try {
                // Get current user ID
                const userResponse = await fetch(`${API_BASE_URL}/auth/me`, { credentials: 'include' });
                const userData = await userResponse.json();

                const orderData = {
                    usuarioId: userData.id,
                    items: cart
                };

                const response = await fetch(`${API_BASE_URL}/pedidos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(orderData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('¬°Pedido realizado exitosamente! üéâ');
                    localStorage.removeItem('cart');
                    window.location.href = 'user-dashboard.html';
                } else {
                    alert(data.error || 'Error al procesar el pedido');
                    checkoutBtn.disabled = false;
                    checkoutBtn.innerHTML = '<i class="fas fa-check-circle"></i> Realizar Pedido';
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Error al procesar el pedido. Int√©ntalo de nuevo.');
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = '<i class="fas fa-check-circle"></i> Realizar Pedido';
            }
        }

        async function logout() {
            await fetch(`${API_BASE_URL}/auth/logout`, { method: 'POST', credentials: 'include' });
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        loadCart();
    </script>
</body>

</html>